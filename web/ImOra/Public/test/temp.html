<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script type="text/javascript" src="/js/jquery/jquery.js"></script>
<script type="text/javascript">

var gRange,it;
function insertHtmlAtCaret(html) {
	var sel, range;
	if (window.getSelection) {
		sel = window.getSelection();
		if (sel.getRangeAt && sel.rangeCount) {
			range = sel.getRangeAt(0);
			range.deleteContents();
			if (gRange){
				range = gRange;
			}
	
			var el = document.createElement("div");
			el.innerHTML = html;
			var frag = document.createDocumentFragment(), node, lastNode;
			while ( (node = el.firstChild) ) {
				lastNode = frag.appendChild(node);
			}
			range.insertNode(frag);
			if (lastNode) {
				range = range.cloneRange();
				range.setStartAfter(lastNode);
				range.collapse(true);
				sel.removeAllRanges();
				sel.addRange(range);
			}
		}
	} else if (document.selection && document.selection.type != "Control") {
		document.selection.createRange().pasteHTML(html);
	}
}

$(function(){
	$('#t').on('focus',function(){
		var sel;
		if (it) return;
		it = setInterval(function(){
			 if (window.getSelection) {
				sel = window.getSelection();
				try{
					if (sel.anchorNode.parentNode.id!='t'){
						return;
					}
			        if (sel.getRangeAt && sel.rangeCount) {
			        	gRange = sel.getRangeAt(0);
			        }
				} catch(e){
					return;
				}
			 }
		},100);
	}).on('keydown', function(evt){
		//alert(navigator.appVersion)
		if (navigator.appVersion.indexOf('MSIE')>=0 || navigator.appVersion.indexOf('Gecko')>=0){
			if (evt.keyCode==13){
				//alert(1);
				evt.preventDefault();
				insertHtmlAtCaret('<br>');
			}		
		}
	}).focus();
});

function a(){
	insertHtmlAtCaret('<img src="appadmin_icon_input.png">');
}
</script>
<style type="text/css">
ul{float:left;width:200px;}
.on{border:1px solid black;}
</style>
</head>
<body>
<!-- 
	<ul id='root1'>
		<li value='all'>全部</li>
	</ul>
	
	<ul id='root2'>
		<li value='all'>全部</li>
	</ul>
	
	<ul id='root3'>
		<li value='all'>全部</li>
	</ul>
	
	<ul id='root4'>
		<li value='all'>全部</li>
	</ul>  -->
	<div id='t' contenteditable='true' style='border:1px solid black;width:500px;height:200px;'></div>
	<button onclick="a();">点击</button>
</body>
<script type="text/javascript">

/**
 * select联动
 * @params obj data 数据
 * @params array objs 联动的select对象数组(jquery对象)
 */
function LinkedSelect(data,params){
	return;
	for(var i=0;i<params.length;i++){
		//给参数加上序号
		params[i].num=i;
		
		//子元素加上行号
		this.setRowNum(params[i]);
		
		params[i].obj.data('param', params[i]);
	}
	
	this.params=params;
	this.data=data;
	this.selected = [];
	
	//绑定事件
	this.bindEvent();
	this.showAll(0);
}

LinkedSelect.prototype = {
	/**
	 * 根据数据select初始化
	 * @params obj _data 数据
	 * @params obj _obj select对象(jquery对象)
	 */
	init: function(_list, _param){
		this.clearSubItems(_param);
		if (!_list){
			return;
		}
		
		//在obj里保存数据
		for(var i=0;i<_list.length;i++){
			var c=_param.obj.find('li:first').clone(true);
			c.attr('value', _list[i]['value']).html(_list[i]['str']);
			_param.obj.append(c);
			c.data('data', _list[i]);
		}
		this.setRowNum(_param);
	},
	/**
	 * 给item标注行号
	 * @param obj _param 数据
	 */
	setRowNum: function(_param){
		_param.obj.find('li').each(function(i){
			$(this).attr('row', i);
		});
	},
	/**
	 * 删除子元素（除第一个all以外）
	 * @param obj _param 数据
	 */
	clearSubItems: function(_param){
		_param.obj.find('li:gt(0)').remove();
	},
	/**
	 * 清空num层一下的item
	 * @param int num 数据层级
	 */
	clearAfterward: function(num){
		for(var i=num+1;i<this.params.length;i++){
			this.clearSubItems(this.params[i]);
		}
	},
	/**
	 * 保存已经选择的item
	 */
	saveSelected: function(){
		for (var i=0;i<this.params.length;i++){
			var obj=this.params[i].obj;
			obj.data('selected', []);
			obj.find('.on').each(function(){
				var _parent=$(this).parent();
				var s=_parent.data('selected');
				s.push($(this).attr('value'));
				_parent.data('selected', s);
			});
		}
	},
	/**
	 * 恢复已经选择的item
	 */
	recoverSelected: function(){
		var _params=this.params;
		setTimeout(function(){
			for (var i=0;i<_params.length;i++){
				var obj=_params[i].obj;
				var s=obj.data('selected');
				obj.find('li').each(function(index){
					if (index==0) return;
					for (var i=0;i<s.length;i++){
						if (s[i] == $(this).attr('value')){
							$(this).addClass('on');
						}
					}
				});
			}
		},30);
	},
	/**
	 * 显示符合条件的item
	 * @param int num 第几层以下的数据
	 * @param obj root 数据(null时代表选择全部)
	 */
	showAll: function(num,root){
		var depth=0;
		this.tmpArr=[];
		if (root){
			for(var i=0;i<root.length;i++){
				this.getDataWithDepth(num, num, root[i]);	
			}
			
			for(var i=0;i<this.tmpArr.length;i++){
				this.tmpArr[i].depth=this.tmpArr[i].depth+1;
			}
		} else {
			this.getDataWithDepth(num, 0, this.data);
		}
		
		this.clearAfterward(num);
		for(var i=0;i<this.tmpArr.length;i++){
			var t=this.tmpArr[i];
			if (num == t.depth){
				continue;
			}
			
			var c=this.params[t.depth].obj.find('li:first').clone(true);
			c.attr('value', t.data.value).html(t.data.str);
			this.params[t.depth].obj.append(c);
			c.data('data', t.data);
		}
		for(var i=0;i<this.params.length;i++){
			this.setRowNum(this.params[i]);
		}
	},
	/**
	 * 递归获得符合条件的数据
	 * @param int num 第几层以下的数据
	 * @param int depth 数据层级，递归用
	 * @param obj data 数据
	 * @return array
	 */
	getDataWithDepth: function(num, depth, data){
		for (var key in data){
			if (key != 'list'){
				if (key == 'value' && depth > num){
					this.tmpArr.push({data:data, depth:depth-1});
				}
				continue;
			} else {
				for(var i=0;i<data.list.length;i++){
					this.getDataWithDepth(num, depth+1, data.list[i]);	
				}
			}
		}
	},
	/**
	 * select绑定事件
	 */
	bindEvent: function(){
		var _params=this.params;
		var _this=this;
		for(var i=0;i<_params.length;i++){
			var _nextParam=_params[i+1]?_params[i+1]:false;
			_params[i].obj.data('nextParam', _nextParam).data('index', i).find('li').on('click', function(){
				var _parent=$(this).parent();
				var _param = _parent.data('param');
				if (_param.multiSelect){
					//多选
					if ($(this).hasClass('on')){
						$(this).removeClass('on');
					} else {
						$(this).addClass('on');
					}
				} else {
					//单选
					_parent.find('.on').removeClass('on');
					$(this).addClass('on');
				}
				
				_this.saveSelected();
				//如果是选择全部
				if ($(this).attr('row')==0 || _parent.find('.on').length==0){
					_parent.find('.on').removeClass('on');
					_this.showAll(_param.num);
					//_this.recoverSelected();
					return;
				} else {
					var tmpArr=[];
					_parent.find('.on').each(function(){
						tmpArr.push($(this).data('data'));
					});
					_this.showAll(_param.num, tmpArr);
					_this.recoverSelected();
				}
				
				var _nextParam=_parent.data('nextParam');
				if (_nextParam==false){
					return;
				}
				
				var _list=[];
				$(this).parent().find('.on').each(function(){
					var _data=$(this).data('data');
					if (!_data.list){
						return;
					}
					for(var i=0;i<_data.list.length;i++){
						_list.push(_data.list[i]);
					}
				});
				
				_this.init(_list,_nextParam);
			});
		}
		this.init(_this.data.list, _params[0]);
	}
}
var data=$.parseJSON('{"str":"root","value":"root_value","list":[{"str":"str1","value":"value1","list":[{"str":"str11","value":"value11","list":[{"str":"str111","value":"value111","list":[{"str":"str1111","value":"value1111"},{"str":"str1112","value":"value1112"}]},{"str":"str112","value":"value112","list":[{"str":"str1121","value":"value1121"},{"str":"str1122","value":"value1122"}]}]},{"str":"str12","value":"value12","list":[{"str":"str121","value":"value121"},{"str":"str122","value":"value122"}]},{"str":"str13","value":"value13","list":[{"str":"str131","value":"value131"},{"str":"str132","value":"value132"}]}]},{"str":"str2","value":"value2","list":[{"str":"str21","value":"value21","list":[{"str":"str211","value":"value211"},{"str":"str212","value":"value212"}]},{"str":"str22","value":"value22"}]},{"str":"str3","value":"value3"}]}');
//var data=$.parseJSON('{"str":"root","value":"root_value","list":[{"str":"str1","value":"value1","list":[{"str":"str11","value":"value11","list":[{"str":"str111","value":"value111"},{"str":"str112","value":"value112"}]},{"str":"str12","value":"value12","list":[{"str":"str121","value":"value121"},{"str":"str122","value":"value122"}]},{"str":"str13","value":"value13","list":[{"str":"str131","value":"value131"},{"str":"str132","value":"value132"}]}]},{"str":"str2","value":"value2","list":[{"str":"str21","value":"value21","list":[{"str":"str211","value":"value211"},{"str":"str212","value":"value212"}]},{"str":"str22","value":"value22"}]},{"str":"str3","value":"value3"}]}');
var params=[
	    {obj: $('#root1'),multiSelect: false},
	    {obj: $('#root2'),multiSelect: true},
	    {obj: $('#root3'),multiSelect: true},
	    {obj: $('#root4'),multiSelect: true}
	];
new LinkedSelect(data,params);


</script>
</html>